<!DOCTYPE html>
<html>
<head>
    <title>Api du système d'alarme</title>
    <script src="/static/jquery.min.js"></script>
    <script src="/static/paho-mqtt.js"></script>

    <script type="text/javascript" >
        const CLIENT_ID = String(Math.floor(Math.random() * 10e16))
        const TOPICLUMIERE   = "lumiere";
        const TOPICALARME   = "alarme";
        const TOPICPORTE = "porte";
        const client = new Paho.Client(location.hostname, Number(location.port), CLIENT_ID);

        onConnectionSuccess = function(data) {                                                 // (5)
            console.log("Connected to MQTT Broker");
            $("#connected").html("Yes");

            // Receive LED level messages.                                                     // (6)
            client.subscribe(TOPICALARME);
            client.subscribe(TOPICLUMIERE);
            client.subscribe(TOPICPORTE);
        };

        client.connect({                                                                       // (7)
           onSuccess: onConnectionSuccess,
           reconnect: true
         });

        client.onConnectionLost = function onConnectionLost(data) {                            // (8)

            if (data.errorCode !== 0) {
              console.log("Disconnected from Connected to MQTT Broker with error " + data.errorMessage);
            } else {
              console.log("Disconnected from MQTT Broker");
            }

            $("#connected").html("No");
        };

        client.onMessageArrived = function onMessageArrived(message) {                         // (9)

            console.log("onMessageArrived:" + message.payloadString + " for topic " + message.destinationName);

            var data = JSON.parse(message.payloadString);


        }

        function lumiere2(){
            payload = {
                "lumiere": "lumiere"
            };

            var message = new Paho.Message(                                                // (11)
               JSON.stringify(payload)
            );

            message.destinationName = TOPICLUMIERE;                                               // (12)
            message.qos = 2;
            message.retained = true;                                                       // (13)
            client.send(message);
        }

        function armerSysteme2(){
            payload = {
                "armer": "armer"
            };

            var message = new Paho.Message(                                                // (11)
               JSON.stringify(payload)
            );

            message.destinationName = TOPICALARME;                                               // (12)
            message.qos = 2;
            message.retained = true;                                                       // (13)
            client.send(message);
        }

        function ouvrePorte2(){
            payload = {
                "porte": "porte"
            };

            var message = new Paho.Message(                                                // (11)
               JSON.stringify(payload)
            );

            message.destinationName = TOPICPORTE;                                               // (12)
            message.qos = 2;
            message.retained = true;                                                       // (13)
            client.send(message);
        }

        

        function lumiere(){
            $.getJSON('/lumiere');
        }

        function armerSysteme(){
            $.getJSON('/armer');
        }

        function ouvrePorte(){
            $.getJSON('/porte');
        }

    </script>

</head>
<body>
    <h1>Gestion du système d'alarme en Flask</h1>
    <button id="armer" onclick="armerSysteme()">Armer le système</button>
    <button id="porte" onclick="ouvrePorte()">Ouvrir la porte</button>
    <button id="lumiere" onclick="lumiere()">Allumer/Éteindre la lumière</button>

    <h1>Gestion du système d'alarme en MQTT</h1>
    CLIENT_ID: <span id="clientId">No</span>
    <br><br>
    Connected to MQTT Broker: <span id="connected">No</span>
    <br><br>
    <button id="armer2" onclick="armerSysteme2()">Armer le système</button>
    <button id="porte2" onclick="ouvrePorte2()">Ouvrir la porte</button>
    <button id="lumiere2" onclick="lumiere2()">Allumer/Éteindre la lumière</button>
</body>
</html>